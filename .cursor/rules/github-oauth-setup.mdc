# GitHub OAuth é…ç½®æŒ‡å—

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜å¦‚ä½•é…ç½® GitHub OAuth åº”ç”¨ä»¥ä½¿ç”¨ NextAuth.js å®ç° GitHub ç™»å½•åŠŸèƒ½ã€‚

## 1. åˆ›å»º GitHub OAuth åº”ç”¨

### æ­¥éª¤ä¸€ï¼šè®¿é—® GitHub Settings

1. ç™»å½•åˆ°ä½ çš„ GitHub è´¦æˆ·
2. ç‚¹å‡»å³ä¸Šè§’å¤´åƒï¼Œé€‰æ‹© **Settings**
3. åœ¨å·¦ä¾§èœå•ä¸­æ‰¾åˆ° **Developer settings**
4. ç‚¹å‡» **OAuth Apps**

### æ­¥éª¤äºŒï¼šåˆ›å»ºæ–°çš„ OAuth åº”ç”¨

1. ç‚¹å‡» **New OAuth App** æŒ‰é’®
2. å¡«å†™åº”ç”¨ä¿¡æ¯ï¼š
   - **Application name**: `NextJS OAuth Demo` (æˆ–ä½ å–œæ¬¢çš„åç§°)
   - **Homepage URL**: `http://localhost:3000`
   - **Authorization callback URL**: `http://localhost:3000/api/auth/callback/github`

### æ­¥éª¤ä¸‰ï¼šè·å–å®¢æˆ·ç«¯å‡­è¯

åˆ›å»ºåº”ç”¨åï¼Œä½ ä¼šçœ‹åˆ°ï¼š

- **Client ID**: è¿™æ˜¯å…¬å¼€çš„æ ‡è¯†ç¬¦
- **Client Secret**: ç‚¹å‡» **Generate a new client secret** ç”Ÿæˆ

âš ï¸ **é‡è¦**: Client Secret åªä¼šæ˜¾ç¤ºä¸€æ¬¡ï¼Œè¯·ç«‹å³å¤åˆ¶ä¿å­˜ã€‚

## 2. ç¯å¢ƒå˜é‡é…ç½®

### åˆ›å»º `.env.local` æ–‡ä»¶

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `.env.local` æ–‡ä»¶ï¼š

```env
# NextAuth.js é…ç½®
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=your-nextauth-secret-key-here

# GitHub OAuth é…ç½®
GITHUB_CLIENT_ID=your-github-client-id
GITHUB_CLIENT_SECRET=your-github-client-secret
```

### ç¯å¢ƒå˜é‡è¯´æ˜

- **NEXTAUTH_URL**: åº”ç”¨çš„åŸºç¡€ URLï¼Œç”Ÿäº§ç¯å¢ƒéœ€è¦æ”¹ä¸ºå®é™…åŸŸå
- **NEXTAUTH_SECRET**: ç”¨äºåŠ å¯† JWT çš„å¯†é’¥ï¼Œå¯ä»¥ä½¿ç”¨ `openssl rand -base64 32` ç”Ÿæˆ
- **GITHUB_CLIENT_ID**: ä» GitHub OAuth åº”ç”¨è·å–çš„å®¢æˆ·ç«¯ ID
- **GITHUB_CLIENT_SECRET**: ä» GitHub OAuth åº”ç”¨è·å–çš„å®¢æˆ·ç«¯å¯†é’¥

## 3. ç”Ÿäº§ç¯å¢ƒé…ç½®

### æ›´æ–° GitHub OAuth åº”ç”¨è®¾ç½®

éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒæ—¶ï¼Œéœ€è¦æ›´æ–° GitHub OAuth åº”ç”¨çš„ URLï¼š

1. **Homepage URL**: `https://yourdomain.com`
2. **Authorization callback URL**: `https://yourdomain.com/api/auth/callback/github`

### æ›´æ–°ç¯å¢ƒå˜é‡

```env
NEXTAUTH_URL=https://yourdomain.com
NEXTAUTH_SECRET=your-production-secret-key
GITHUB_CLIENT_ID=your-github-client-id
GITHUB_CLIENT_SECRET=your-github-client-secret
```

## 4. å®‰å…¨æœ€ä½³å®è·µ

### å¯†é’¥ç®¡ç†

- ğŸ”’ **æ°¸è¿œä¸è¦**å°† `.env.local` æ–‡ä»¶æäº¤åˆ° git
- ğŸ”’ ä½¿ç”¨å¼ºéšæœºå¯†é’¥ä½œä¸º `NEXTAUTH_SECRET`
- ğŸ”’ å®šæœŸè½®æ¢ç”Ÿäº§ç¯å¢ƒçš„å¯†é’¥
- ğŸ”’ ä½¿ç”¨ç¯å¢ƒå˜é‡ç®¡ç†å·¥å…·ï¼ˆå¦‚ Vercelã€Railway ç­‰å¹³å°çš„ç¯å¢ƒå˜é‡è®¾ç½®ï¼‰

### æƒé™æ§åˆ¶

- ğŸ“ GitHub OAuth åº”ç”¨é»˜è®¤åªè¯·æ±‚åŸºæœ¬çš„ç”¨æˆ·ä¿¡æ¯æƒé™
- ğŸ“ å¦‚éœ€è¦æ›´å¤šæƒé™ï¼Œå¯åœ¨ NextAuth é…ç½®ä¸­æ·»åŠ  scope å‚æ•°
- ğŸ“ éµå¾ªæœ€å°æƒé™åŸåˆ™ï¼Œåªè¯·æ±‚å¿…è¦çš„æƒé™

## 5. æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

**é—®é¢˜**: "Authorization callback URL mismatch"

- **è§£å†³**: ç¡®ä¿ GitHub OAuth åº”ç”¨çš„å›è°ƒ URL ä¸ `NEXTAUTH_URL` åŒ¹é…

**é—®é¢˜**: "Invalid client secret"

- **è§£å†³**: é‡æ–°ç”Ÿæˆ Client Secret å¹¶æ›´æ–°ç¯å¢ƒå˜é‡

**é—®é¢˜**: "NEXTAUTH_SECRET missing"

- **è§£å†³**: ç¡®ä¿åœ¨ `.env.local` ä¸­è®¾ç½®äº† `NEXTAUTH_SECRET`

### è°ƒè¯•æ¨¡å¼

åœ¨å¼€å‘ç¯å¢ƒä¸­ï¼Œå¯ä»¥å¯ç”¨ NextAuth è°ƒè¯•æ¨¡å¼ï¼š

```env
NEXTAUTH_DEBUG=true
```

è¿™ä¼šåœ¨æ§åˆ¶å°è¾“å‡ºè¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯ã€‚

## 6. æŠ€æœ¯æ¶æ„

### NextAuth.js å·¥ä½œæµç¨‹

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant App as Next.js åº”ç”¨
    participant GitHub as GitHub OAuth
    participant NextAuth as NextAuth.js

    User->>App: ç‚¹å‡»ç™»å½•
    App->>NextAuth: signIn('github')
    NextAuth->>GitHub: é‡å®šå‘åˆ°æˆæƒé¡µé¢
    GitHub->>User: æ˜¾ç¤ºæˆæƒç¡®è®¤
    User->>GitHub: ç¡®è®¤æˆæƒ
    GitHub->>NextAuth: è¿”å›æˆæƒç 
    NextAuth->>GitHub: äº¤æ¢è®¿é—®ä»¤ç‰Œ
    GitHub->>NextAuth: è¿”å›è®¿é—®ä»¤ç‰Œå’Œç”¨æˆ·ä¿¡æ¯
    NextAuth->>App: åˆ›å»ºä¼šè¯
    App->>User: ç™»å½•æˆåŠŸï¼Œæ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
```

### æ–‡ä»¶ç»“æ„

```
src/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/auth/[...nextauth]/
â”‚   â”‚   â””â”€â”€ route.ts              # NextAuth API è·¯ç”±
â”‚   â””â”€â”€ auth/signin/
â”‚       â””â”€â”€ page.tsx              # è‡ªå®šä¹‰ç™»å½•é¡µé¢
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ Navigation.tsx            # å¯¼èˆªç»„ä»¶ï¼ˆåŒ…å«ç™»å½•çŠ¶æ€ï¼‰
â”‚   â””â”€â”€ SessionProvider.tsx      # Session ä¸Šä¸‹æ–‡æä¾›è€…
â”œâ”€â”€ features/auth/
â”‚   â”œâ”€â”€ SignInForm.tsx           # ç™»å½•è¡¨å•ç»„ä»¶
â”‚   â”œâ”€â”€ UserProfile.tsx          # ç”¨æˆ·ä¿¡æ¯ç»„ä»¶
â”‚   â””â”€â”€ index.ts                 # ç»Ÿä¸€å¯¼å‡º
â””â”€â”€ types/
    â””â”€â”€ next-auth.d.ts           # NextAuth ç±»å‹æ‰©å±•
```

## 7. æ‰©å±•åŠŸèƒ½

### æ·»åŠ æ›´å¤š OAuth æä¾›å•†

NextAuth.js æ”¯æŒå¤šç§ OAuth æä¾›å•†ï¼š

```typescript
import GoogleProvider from 'next-auth/providers/google';
import DiscordProvider from 'next-auth/providers/discord';

export const authOptions: NextAuthOptions = {
  providers: [
    GitHubProvider({
      clientId: process.env.GITHUB_CLIENT_ID!,
      clientSecret: process.env.GITHUB_CLIENT_SECRET!,
    }),
    GoogleProvider({
      clientId: process.env.GOOGLE_CLIENT_ID!,
      clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
    }),
    DiscordProvider({
      clientId: process.env.DISCORD_CLIENT_ID!,
      clientSecret: process.env.DISCORD_CLIENT_SECRET!,
    }),
  ],
  // ...å…¶ä»–é…ç½®
};
```

### æ•°æ®åº“é›†æˆ

å¯ä»¥é›†æˆæ•°æ®åº“æ¥æŒä¹…åŒ–ç”¨æˆ·ä¿¡æ¯ï¼š

```typescript
import { PrismaAdapter } from '@next-auth/prisma-adapter';
import { prisma } from '@/lib/prisma';

export const authOptions: NextAuthOptions = {
  adapter: PrismaAdapter(prisma),
  // ...å…¶ä»–é…ç½®
};
```

### è§’è‰²å’Œæƒé™ç®¡ç†

é€šè¿‡å›è°ƒå‡½æ•°å®ç°è§’è‰²ç®¡ç†ï¼š

```typescript
export const authOptions: NextAuthOptions = {
  callbacks: {
    async jwt({ token, user, account }) {
      if (user) {
        token.role = user.role;
      }
      return token;
    },
    async session({ session, token }) {
      session.user.role = token.role;
      return session;
    },
  },
  // ...å…¶ä»–é…ç½®
};
```

## 8. ç›¸å…³èµ„æº

- [NextAuth.js å®˜æ–¹æ–‡æ¡£](https://next-auth.js.org/)
- [GitHub OAuth Apps æ–‡æ¡£](https://docs.github.com/en/apps/oauth-apps)
- [Next.js è®¤è¯æŒ‡å—](https://nextjs.org/docs/pages/building-your-application/authenticating)
- [OAuth 2.0 è§„èŒƒ](https://tools.ietf.org/html/rfc6749)
